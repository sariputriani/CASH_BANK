public function report(Request $request) {
    $search = $request->keyword;
    $tahun = $request->tahun;
    $bankTujuanId = $request->bank_tujuan;
    $sumberDanaIds = $request->sumber_dana; // Sekarang array
    $rekapanVA = $request->rekapanVA;
    $filterJenis = $request->jenis_pembayaran;

    // Ambil daftar tahun untuk dropdown
    $tahunList = GabunganMasukKeluar::select(DB::raw('YEAR(tanggal) as tahun'))
        ->groupBy(DB::raw('YEAR(tanggal)'))
        ->orderByDesc('tahun')
        ->pluck('tahun');
    
    

    // Query utama untuk data bank keluar
    // $query = GabunganMasukKeluar::with(['bankTujuan', 'sumberDana'])
    //     //  ->where('jenis', 'Keluar') // ðŸ”¥ INI KUNCI
    //      ->orderBy('tanggal', 'asc');
    $query = GabunganMasukKeluar::with(['bankTujuan', 'sumberDana'])
     ->orderBy('id_gabungan', 'asc');

    if ($tahun) {
        $query->whereYear('tanggal', $tahun);
    }

    if ($bankTujuanId) {
        $query->where('id_bank_tujuan', $bankTujuanId);
    }


    // Filter Sumber Dana - handle multiple selection
    if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
        $query->whereIn('id_sumber_dana', $sumberDanaIds);
    }
    
    if ($kategoriIds = request('kategori')) {
        $query->whereIn('id_kategori_kriteria', $kategoriIds);
    }

    $kategoriList = GabunganMasukKeluar::select(
        'kategori_kriteria.id_kategori_kriteria',
        'kategori_kriteria.nama_kriteria',
        DB::raw('COALESCE(SUM(gabungan_masuk_keluars.kredit),0) as total_kredit')
    )
    ->join('kategori_kriteria', 'kategori_kriteria.id_kategori_kriteria', '=', 'gabungan_masuk_keluars.id_kategori_kriteria')
    ->where('jenis', 'Keluar')
    ->when($tahun, fn($q) => $q->whereYear('tanggal', $tahun))
    ->when($sumberDanaIds, fn($q) => $q->whereIn('id_sumber_dana', $sumberDanaIds))
    ->when($kategoriIds, fn($q) => $q->whereIn('kategori_kriteria.id_kategori_kriteria', $kategoriIds))
    ->groupBy('kategori_kriteria.id_kategori_kriteria', 'kategori_kriteria.nama_kriteria')
    ->orderBy('kategori_kriteria.nama_kriteria')
    ->get();
    

    if ($search) {
        $query->where(function($q) use ($search) {
            $q->where('tanggal', 'like', "%{$search}%")
              ->orWhere('penerima', 'like', "%{$search}%")
              ->orWhere('uraian', 'like', "%{$search}%")
              ->orWhere('agenda_tahun', 'like', "%{$search}%")
              ->orWhereHas('bankTujuan', function($q) use ($search) {
                  $q->where('nama_tujuan', 'like', "%{$search}%");
              });
        });
    }

    $data = $query->get();

    // Hitung saldo akhir
    $saldoAkhir = 0;
    foreach ($data as $row) {
        $saldoAkhir += ($row->debet ?? 0) - ($row->kredit ?? 0);
        $row->saldo_akhir = $saldoAkhir;
    }

    // Query untuk agendaData (jenis pembayaran)
    $agendaData = GabunganMasukKeluar::select(
            'gabungan_masuk_keluars.id_gabungan',
            'gabungan_masuk_keluars.tanggal',
            'gabungan_masuk_keluars.nomor_agenda',
            'gabungan_masuk_keluars.agenda_tahun',
            'gabungan_masuk_keluars.uraian',
            'gabungan_masuk_keluars.kredit',
            'gabungan_masuk_keluars.penerima',
            'gabungan_masuk_keluars.jenis_pembayaran'
        )
        ->where('gabungan_masuk_keluars.jenis', 'Keluar')
        ->where('gabungan_masuk_keluars.kredit', '>', 0);

    if ($tahun) {
        $agendaData->whereYear('gabungan_masuk_keluars.tanggal', $tahun);
    }

    // Filter Sumber Dana untuk agenda
    if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
        $agendaData->whereIn('gabungan_masuk_keluars.id_sumber_dana', $sumberDanaIds);
    }

    if ($filterJenis === '_null') {
        $agendaData->whereNull('gabungan_masuk_keluars.jenis_pembayaran');
    } elseif (!empty($filterJenis)) {
        $agendaData->where('gabungan_masuk_keluars.jenis_pembayaran', $filterJenis);
    }

    $agendaData = $agendaData->orderBy('gabungan_masuk_keluars.agenda_tahun')
        ->orderBy('gabungan_masuk_keluars.nomor_agenda')
        ->get();

    // Rekap jenis pembayaran
    $rekapJenisPembayaran = GabunganMasukKeluar::select('jenis_pembayaran')
        ->where('jenis', 'Keluar')
        ->where('kredit', '>', 0)
        ->groupBy('jenis_pembayaran')
        ->orderBy('jenis_pembayaran')
        ->get();

    // REKAP
    $rekap = [];
    if ($rekapanVA && $tahun) {
        switch($rekapanVA) {
            case 'bank':
                foreach (BankTujuan::all() as $bank) {
                    $bankQuery = GabunganMasukKeluar::whereYear('tanggal', $tahun)
                        ->where('id_bank_tujuan', $bank->id_bank_tujuan);
                    
                    // Apply sumber dana filter
                    if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
                        $bankQuery->whereIn('id_sumber_dana', $sumberDanaIds);
                    }
                    
                    $saldo = $bankQuery->sum(DB::raw('debet - kredit'));

                    $rekap[] = [
                        'bank' => $bank->nama_tujuan,
                        'saldo_va' => $saldo,
                        'saldo_sap' => 0,
                        'selisih' => $saldo,
                        'keterangan' => "Saldo akhir tahun {$tahun}"
                    ];
                }
                break;

            case 'va':
                $sumberDanaQuery = SumberDana::query();
                
                // Filter hanya sumber dana yang dipilih
                if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
                    $sumberDanaQuery->whereIn('id_sumber_dana', $sumberDanaIds);
                }
                
                foreach ($sumberDanaQuery->get() as $sd) {
                    $saldo = GabunganMasukKeluar::whereYear('tanggal', $tahun)
                        ->where('id_sumber_dana', $sd->id_sumber_dana)
                        ->sum(DB::raw('debet - kredit'));

                    $rekap[] = [
                        'bank' => $sd->nama_sumber_dana,
                        'saldo_va' => $saldo,
                        'saldo_sap' => 0,
                        'selisih' => $saldo,
                        'keterangan' => "Saldo akhir tahun {$tahun}"
                    ];
                }
                break;

            case 'kategori-full':
                $dataKategoriQuery = GabunganMasukKeluar::select(
                    'kategori_kriteria.nama_kriteria as kategori',
                    'sub_kriteria.nama_sub_kriteria as sub',
                    'item_sub_kriteria.nama_item_sub_kriteria as item',
                    DB::raw('COALESCE(SUM(gabungan_masuk_keluars.kredit),0) as kredit')
                )
                ->join('kategori_kriteria', 'kategori_kriteria.id_kategori_kriteria', '=', 'gabungan_masuk_keluars.id_kategori_kriteria')
                ->join('sub_kriteria', 'sub_kriteria.id_sub_kriteria', '=', 'gabungan_masuk_keluars.id_sub_kriteria')
                ->join('item_sub_kriteria', 'item_sub_kriteria.id_item_sub_kriteria', '=', 'gabungan_masuk_keluars.id_item_sub_kriteria')
                ->whereYear('tanggal', $tahun);
                
                // Apply sumber dana filter
                if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
                    $dataKategoriQuery->whereIn('gabungan_masuk_keluars.id_sumber_dana', $sumberDanaIds);
                }
                
                $dataKategori = $dataKategoriQuery->groupBy('kategori_kriteria.nama_kriteria', 'sub_kriteria.nama_sub_kriteria', 'item_sub_kriteria.nama_item_sub_kriteria')
                    ->orderBy('kategori_kriteria.nama_kriteria')
                    ->get();

                foreach ($dataKategori as $row) {
                    $rekap[$row->kategori][$row->sub][] = [
                        'item' => $row->item,
                        'kredit' => floatval($row->kredit)
                    ];
                }
                break;
                            
                // Apply sumber dana filter
                // if ($sumberDanaIds && is_array($sumberDanaIds) && count($sumberDanaIds) > 0) {
                //     $rekapKategoriQuery->whereIn('gabungan_masuk_keluars.id_sumber_dana', $sumberDanaIds);
                // }
            case 'kategori':
                $rekapKategoriQuery = GabunganMasukKeluar::select(
                    'kategori_kriteria.nama_kriteria as kategori',
                    DB::raw('COALESCE(SUM(gabungan_masuk_keluars.kredit),0) as total_kredit')
                )
                ->join('kategori_kriteria', 'kategori_kriteria.id_kategori_kriteria', '=', 'gabungan_masuk_keluars.id_kategori_kriteria')
                ->whereYear('tanggal', $tahun);

                
                $rekap = $rekapKategoriQuery->groupBy('kategori_kriteria.nama_kriteria')
                    ->orderBy('kategori_kriteria.nama_kriteria')
                    ->get();
                break;
        }
    }

    return view('cash_bank.reportKeluar', [
        'data' => $data,
        'bankTujuanList' => BankTujuan::all(),
        'sumberDanaList' => SumberDana::all(),
        'tahunList' => $tahunList,
        'kategoriList' => $kategoriList,
        'selectedBankTujuan' => $bankTujuanId,
        'selectedSumberDana' => $sumberDanaIds, // Sekarang array
        'selectedKategori' => $kategoriIds, // Sekarang array
        'selectedTahun' => $tahun,
        'rekapVA' => $rekap,
        'rekapanVA' => $rekapanVA,
        'agendaData' => $agendaData,
        'rekapJenisPembayaran' => $rekapJenisPembayaran,
        'selectedJenis' => $filterJenis,
        
    ]);
}