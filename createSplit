<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bank Keluar Multi Input</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .split-row {
            background: #f8f9fa;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #FF7518;
            position: relative;
        }
        .split-row.first-row {
            border-left-color: #28a745;
        }
        .remove-split {
            position: absolute;
            top: 10px;
            right: 10px;
            cursor: pointer;
            color: #dc3545;
            font-size: 20px;
            font-weight: bold;
        }
        .remove-split:hover {
            color: #a02622;
        }
        #total-info {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        .add-split-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }
        .add-split-btn:hover {
            background: #218838;
        }
    </style>
</head>
<body>

<div class="modal fade show" id="ModalCreate" style="display: block; background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Tambah Data <span style="color:#FF7518">Bank Keluar</span> - Multiple Split</h5>
                <button type="button" class="btn-close"></button>
            </div>
            <form id="formBankKeluar" method="post">
                <div class="modal-body">

                    <!-- Info Agenda -->
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label">Agenda <span class="text-danger">*</span></label>
                            <select name="agenda_tahun" id="dokumen_id" class="form-select" required>
                                <option value="">Pilih Agenda</option>
                                <option value="123" data-nilai="12000000">10_2025 - Pembayaran Pegawai</option>
                                <option value="124" data-nilai="8000000">11_2025 - Operasional</option>
                            </select>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Sumber Dana <span class="text-danger">*</span></label>
                            <select name="id_sumber_dana" id="id_sumber_dana" class="form-select" required>
                                <option value="">Pilih Sumber Dana</option>
                                <option value="1">APBN</option>
                                <option value="2">APBD</option>
                            </select>
                        </div>
                    </div>

                    <!-- Total Info -->
                    <div id="total-info" class="mt-3 d-none">
                        <div class="row">
                            <div class="col-md-4">
                                <small>Nilai Total Agenda</small>
                                <h5 id="nilai-agenda">Rp 0</h5>
                            </div>
                            <div class="col-md-4">
                                <small>Total Input Saat Ini</small>
                                <h5 id="total-input">Rp 0</h5>
                            </div>
                            <div class="col-md-4">
                                <small>Sisa</small>
                                <h5 id="sisa-nilai">Rp 0</h5>
                            </div>
                        </div>
                    </div>

                    <!-- Info Global -->
                    <div class="row mt-3">
                        <div class="col-md-12">
                            <label class="form-label">Uraian Global</label>
                            <textarea name="uraian_global" id="uraian" class="form-control" rows="2" placeholder="Uraian untuk semua split"></textarea>
                        </div>
                    </div>

                    <div class="row mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Penerima</label>
                            <input type="text" name="penerima" id="penerima" class="form-control" placeholder="Penerima">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Bank Tujuan</label>
                            <select name="id_bank_tujuan" id="id_bank_tujuan" class="form-select">
                                <option value="">Pilih Bank</option>
                                <option value="1">BRI</option>
                                <option value="2">BNI</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tanggal <span class="text-danger">*</span></label>
                            <input type="date" name="tanggal" id="tanggal" class="form-control" required>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h6 class="mb-3">üìù Detail Pembayaran (Split)</h6>

                    <!-- Container untuk multiple splits -->
                    <div id="splits-container">
                        <!-- Row pertama (template) -->
                        <div class="split-row first-row" data-index="0">
                            <span class="badge bg-success mb-2">Item #1</span>
                            
                            <div class="row">
                                <div class="col-md-3">
                                    <label class="form-label">Kriteria CF</label>
                                    <select name="splits[0][id_kategori_kriteria]" class="form-select kategori-select" data-index="0">
                                        <option value="">Pilih Kriteria</option>
                                        <option value="1">Belanja Pegawai</option>
                                        <option value="2">Belanja Barang</option>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Sub Kriteria</label>
                                    <select name="splits[0][id_sub_kriteria]" class="form-select sub-kriteria-select" data-index="0">
                                        <option value="">Pilih Sub Kriteria</option>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Item Sub Kriteria <span class="text-danger">*</span></label>
                                    <select name="splits[0][id_item_sub_kriteria]" class="form-select item-select" data-index="0" required>
                                        <option value="">Pilih Item</option>
                                    </select>
                                </div>

                                <div class="col-md-3">
                                    <label class="form-label">Nilai Kredit <span class="text-danger">*</span></label>
                                    <input type="number" name="splits[0][kredit]" class="form-control kredit-input" data-index="0" placeholder="0" step="0.01" required>
                                </div>
                            </div>

                            <div class="row mt-2">
                                <div class="col-md-12">
                                    <label class="form-label">Keterangan</label>
                                    <input type="text" name="splits[0][keterangan]" class="form-control" placeholder="Keterangan untuk item ini">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Button Tambah Split -->
                    <button type="button" class="add-split-btn" id="btnAddSplit">
                        ‚ûï Tambah Item Pembayaran
                    </button>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary">Cancel</button>
                    <button type="submit" class="btn btn-primary">üíæ Simpan Semua (<span id="count-splits">1</span> item)</button>
                </div>

            </form>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
// Data dummy untuk dropdown cascade
const subKriteriaData = {
    "1": [
        {id: 1, nama: "Gaji Pokok"},
        {id: 2, nama: "Tunjangan"}
    ],
    "2": [
        {id: 3, nama: "ATK"},
        {id: 4, nama: "Perjalanan Dinas"}
    ]
};

const itemSubKriteriaData = {
    "1": [
        {id: 1, nama: "Gaji"},
        {id: 2, nama: "Lembur"},
        {id: 3, nama: "THR"}
    ],
    "2": [
        {id: 4, nama: "Uang Makan"},
        {id: 5, nama: "Transport"}
    ],
    "3": [{id: 6, nama: "Kertas"}, {id: 7, nama: "Pulpen"}],
    "4": [{id: 8, nama: "Hotel"}, {id: 9, nama: "Tiket"}]
};

let splitIndex = 1;
let nilaiAgenda = 0;

$(document).ready(function() {
    
    // Event: Pilih Agenda
    $('#dokumen_id').on('change', function() {
        const nilai = $(this).find(':selected').data('nilai') || 0;
        nilaiAgenda = parseFloat(nilai);
        
        if (nilaiAgenda > 0) {
            $('#total-info').removeClass('d-none');
            $('#nilai-agenda').text('Rp ' + nilaiAgenda.toLocaleString('id-ID'));
            hitungTotal();
        }
    });

    // Event: Tambah Split Baru
    $('#btnAddSplit').on('click', function() {
        const newRow = `
        <div class="split-row" data-index="${splitIndex}">
            <span class="badge bg-primary mb-2">Item #${splitIndex + 1}</span>
            <span class="remove-split" data-index="${splitIndex}">√ó</span>
            
            <div class="row">
                <div class="col-md-3">
                    <label class="form-label">Kriteria CF</label>
                    <select name="splits[${splitIndex}][id_kategori_kriteria]" class="form-select kategori-select" data-index="${splitIndex}">
                        <option value="">Pilih Kriteria</option>
                        <option value="1">Belanja Pegawai</option>
                        <option value="2">Belanja Barang</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Sub Kriteria</label>
                    <select name="splits[${splitIndex}][id_sub_kriteria]" class="form-select sub-kriteria-select" data-index="${splitIndex}">
                        <option value="">Pilih Sub Kriteria</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Item Sub Kriteria <span class="text-danger">*</span></label>
                    <select name="splits[${splitIndex}][id_item_sub_kriteria]" class="form-select item-select" data-index="${splitIndex}" required>
                        <option value="">Pilih Item</option>
                    </select>
                </div>

                <div class="col-md-3">
                    <label class="form-label">Nilai Kredit <span class="text-danger">*</span></label>
                    <input type="number" name="splits[${splitIndex}][kredit]" class="form-control kredit-input" data-index="${splitIndex}" placeholder="0" step="0.01" required>
                </div>
            </div>

            <div class="row mt-2">
                <div class="col-md-12">
                    <label class="form-label">Keterangan</label>
                    <input type="text" name="splits[${splitIndex}][keterangan]" class="form-control" placeholder="Keterangan untuk item ini">
                </div>
            </div>
        </div>
        `;
        
        $('#splits-container').append(newRow);
        splitIndex++;
        updateSplitCount();
    });

    // Event: Hapus Split
    $(document).on('click', '.remove-split', function() {
        const index = $(this).data('index');
        $(`.split-row[data-index="${index}"]`).remove();
        updateSplitCount();
        hitungTotal();
    });

    // Event: Cascade Dropdown - Kategori -> Sub Kriteria
    $(document).on('change', '.kategori-select', function() {
        const index = $(this).data('index');
        const kategoriId = $(this).val();
        const subSelect = $(`.sub-kriteria-select[data-index="${index}"]`);
        const itemSelect = $(`.item-select[data-index="${index}"]`);
        
        subSelect.empty().append('<option value="">Pilih Sub Kriteria</option>');
        itemSelect.empty().append('<option value="">Pilih Item</option>');
        
        if (kategoriId && subKriteriaData[kategoriId]) {
            subKriteriaData[kategoriId].forEach(sub => {
                subSelect.append(`<option value="${sub.id}">${sub.nama}</option>`);
            });
        }
    });

    // Event: Cascade Dropdown - Sub Kriteria -> Item
    $(document).on('change', '.sub-kriteria-select', function() {
        const index = $(this).data('index');
        const subId = $(this).val();
        const itemSelect = $(`.item-select[data-index="${index}"]`);
        
        itemSelect.empty().append('<option value="">Pilih Item</option>');
        
        if (subId && itemSubKriteriaData[subId]) {
            itemSubKriteriaData[subId].forEach(item => {
                itemSelect.append(`<option value="${item.id}">${item.nama}</option>`);
            });
        }
    });

    // Event: Hitung Total saat input kredit
    $(document).on('input', '.kredit-input', function() {
        hitungTotal();
    });

    // Fungsi: Hitung Total
    function hitungTotal() {
        let total = 0;
        $('.kredit-input').each(function() {
            const val = parseFloat($(this).val()) || 0;
            total += val;
        });
        
        const sisa = nilaiAgenda - total;
        
        $('#total-input').text('Rp ' + total.toLocaleString('id-ID'));
        $('#sisa-nilai').text('Rp ' + sisa.toLocaleString('id-ID'));
        
        // Warning jika over
        if (sisa < 0) {
            $('#sisa-nilai').css('color', '#dc3545');
            $('#total-info').css('background', 'linear-gradient(135deg, #dc3545 0%, #c92a2a 100%)');
        } else {
            $('#sisa-nilai').css('color', 'white');
            $('#total-info').css('background', 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)');
        }
    }

    // Fungsi: Update jumlah split
    function updateSplitCount() {
        const count = $('.split-row').length;
        $('#count-splits').text(count);
    }

    // Submit Form
    $('#formBankKeluar').on('submit', function(e) {
        e.preventDefault();
        
        // Validasi total
        let total = 0;
        $('.kredit-input').each(function() {
            total += parseFloat($(this).val()) || 0;
        });
        
        if (total > nilaiAgenda) {
            alert('‚ùå Total pembayaran (Rp ' + total.toLocaleString('id-ID') + ') melebihi nilai agenda (Rp ' + nilaiAgenda.toLocaleString('id-ID') + ')!');
            return false;
        }
        
        // Simulasi success
        alert('‚úÖ Berhasil menyimpan ' + $('.split-row').length + ' item pembayaran!\n\nTotal: Rp ' + total.toLocaleString('id-ID'));
        
        // Di implementasi sebenarnya, submit via AJAX atau form normal
        // $(this).unbind('submit').submit();
    });
});
</script>

</body>
</html>