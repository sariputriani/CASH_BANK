<div class="container-fluid"style="text-align: center;margin-bottom:200px;">
                            <h1>Demo Multiselect Box In PHP</h1>
                            <div class="row">
                                <div class="col-md-12" >

                                    <form id="myForm" method="POST">
                                        <input name="sumber_dana_values" type="hidden" value="" id="sumber_dana_values">
                                        <div class="col-md-12" >
                                            <select size="5" name="sumber_dana" multiple="multiple" id="sumber_dana">
                                                @foreach($sumberDanaList as $sd)
                                                    <option value="{{ $sd->id_sumber_dana }}" {{ request('sumber_dana') == $sd->id_sumber_dana ? 'selected' : '' }}>
                                                        {{ $sd->nama_sumber_dana }}
                                                    </option>
                                                @endforeach
                                            </select>
                                        </div>
                                        <div class="col-md-12" style="margin-top:20px;" >
                                                <input type="submit" value="Submit" >
                                            </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        @push('scripts')
<script>
$(document).ready(function() {

    $('#sumber_dana').multiselect({
        nonSelectedText: 'Pilih Sumber Dana',
        enableFiltering: true,
        enableCaseInsensitiveFiltering: true,
        buttonWidth: '100%',
        maxHeight: 300,

        buttonText: function(options) {
            if (options.length === 0) {
                return 'Pilih Sumber Dana';
            }

            var selected = [];
            options.each(function() {
                selected.push($(this).text());
            });

            $('#sumber_dana_values').val(selected.join(','));
            return selected.join(', ');
        }
    });

});
</script>
@endpush
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>
@stack('scripts')
   <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">


   
                        <!-- bawah ini yang benar -->
                        <!-- <select name="sumber_dana" class="form-select" onchange="this.form.submit()">
                        <option value="">Semua Sumber Dana</option>
                        @foreach($sumberDanaList as $sd)
                            <option value="{{ $sd->id_sumber_dana }}" {{ request('sumber_dana') == $sd->id_sumber_dana ? 'selected' : '' }}>
                                {{ $sd->nama_sumber_dana }}
                            </option>
                        @endforeach -->


                        
                        <!-- <div class="input-group search-box w-50">
                            <span class="input-group-text bg-white border-end-0">
                                <i class="bi bi-search"></i>
                            </span>
                            <input type="text" 
                                name="keyword" 
                                class="form-control border-start-0" 
                                placeholder="Search Here..."
                                value="{{ request('keyword') }}">
                        </div> -->



@extends("layouts/index")
@section('content')

<div class="container-fluid mt-4">
    <h1 class="tittle">Report <span style="color: #FF7518">Bank Keluar</span></h1>
    <small>Ini daftar Report Bank Keluar</small>
    
    <div class="row mt-4">
        <div class="col-md-12">
            <div class="card rounded-3 border-0 shadow-sm">
                <div class="card-body">
                    <!-- <form action="{{ route('bank-keluar.report') }}" method="GET" class="d-flex justify-content-between align-items-center">

                        <div class="w-25">
                            <select name="tahun" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Pilih Tahun --</option>
                                @foreach($tahunList as $t)
                                    <option value="{{ $t }}" {{ request('tahun') == $t ? 'selected' : '' }}>
                                        {{ $t }}
                                    </option>
                                @endforeach
                            </select>
                        </div>

                        <div class="w-25 mx-3">
                            <select name="bank_tujuan" class="form-select" onchange="this.form.submit()">
                                <option value="">Semua Bank Tujuan</option>
                                @foreach($bankTujuanList as $bank)
                                    <option value="{{ $bank->id_bank_tujuan }}" {{ request('bank_tujuan') == $bank->id_bank_tujuan ? 'selected' : '' }}>
                                        {{ $bank->nama_tujuan }}
                                    </option>
                                @endforeach
                            </select>
                        </div>
                        <div class="w-25 mx-3"> 
                            <select id="multipleSelect" multiple name="sumber_dana[]" placeholder="Pilih Sumber Dana" data-search="true" data-silent-initial-value-set="true">
                                @foreach($sumberDanaList as $sd)
                                    <option value="{{ $sd->id_sumber_dana }}" {{ request('sumber_dana') == $sd->id_sumber_dana ? 'selected' : '' }}>
                                        {{ $sd->nama_sumber_dana }}
                                    </option>
                                @endforeach 
                            </select>
                        </div>

                        <div class="w-25 mx-3">
                            <select name="rekapanVA" class="form-select" onchange="this.form.submit()">
                                <option value="">-- Pilih Rekapan --</option>

                                <option value="va" {{ request('rekapanVA') == 'va' ? 'selected' : '' }}>
                                    Saldo VA
                                </option>

                                <option value="bank" {{ request('rekapanVA') == 'bank' ? 'selected' : '' }}>
                                    Saldo BANK
                                </option>
                               <option value="kategori-full" {{ request('rekapanVA') == 'kategori-full' ? 'selected' : '' }}>
                                    Kategori Full
                                </option>
                               <option value="kategori" {{ request('rekapanVA') == 'kategori' ? 'selected' : '' }}>
                                    Kategori
                                </option>
                            </select>
                        </div>
                        


                        <div class="d-flex gap-2">
                            <button type="submit" class="btn">
                                <i class="bi bi-funnel"></i> Filter
                            </button>
                            <a href="{{ route('bank-keluar.report') }}" class="btn">
                                <i class="bi bi-arrow-clockwise"></i> Reset
                            </a>
                            <a href="#" onclick="window.print()" class="btn btn-sm">
                                <i class="bi bi-printer"></i> Print
                            </a>
                            <a href="#" class="btn ">
                                <i class="bi bi-file-earmark-excel"></i> Export Excel
                            </a>
                        </div>
                    </form> -->

                    <form action="{{ route('bank-keluar.report') }}" method="GET" id="filterForm" class="d-flex justify-content-between align-items-center">
   
                    <!-- Tahun -->
                    <div class="w-25">
                        <select name="tahun" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Tahun --</option>
                            @foreach($tahunList as $t)
                                <option value="{{ $t }}" {{ request('tahun') == $t ? 'selected' : '' }}>
                                    {{ $t }}
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <!-- Bank Tujuan -->
                    <div class="w-25 mx-3">
                        <select name="bank_tujuan" class="form-select" onchange="this.form.submit()">
                            <option value="">Semua Bank Tujuan</option>
                            @foreach($bankTujuanList as $bank)
                                <option value="{{ $bank->id_bank_tujuan }}" {{ request('bank_tujuan') == $bank->id_bank_tujuan ? 'selected' : '' }}>
                                    {{ $bank->nama_tujuan }}
                                </option>
                            @endforeach
                        </select>
                    </div>

                    <!-- Sumber Dana (VirtualSelect Multiple) -->
                    <div class="w-25 mx-3"> 
                        <select id="multipleSelect" multiple name="sumber_dana[]">
                            @foreach($sumberDanaList as $sd)
                                <option value="{{ $sd->id_sumber_dana }}" 
                                    {{ in_array($sd->id_sumber_dana, request('sumber_dana', [])) ? 'selected' : '' }}>
                                    {{ $sd->nama_sumber_dana }}
                                </option>
                            @endforeach 
                        </select>
                    </div>

                    <!-- Rekapan -->
                    <div class="w-25 mx-3">
                        <select name="rekapanVA" class="form-select" onchange="this.form.submit()">
                            <option value="">-- Pilih Rekapan --</option>
                            <option value="va" {{ request('rekapanVA') == 'va' ? 'selected' : '' }}>
                                Saldo VA
                            </option>
                            <option value="bank" {{ request('rekapanVA') == 'bank' ? 'selected' : '' }}>
                                Saldo BANK
                            </option>
                            <option value="kategori-full" {{ request('rekapanVA') == 'kategori-full' ? 'selected' : '' }}>
                                Kategori Full
                            </option>
                            <option value="kategori" {{ request('rekapanVA') == 'kategori' ? 'selected' : '' }}>
                                Kategori
                            </option>
                        </select>
                    </div>

                    <!-- Buttons -->
                    <div class="d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-funnel"></i> Filter
                        </button>
                        <a href="{{ route('bank-keluar.report') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-clockwise"></i> Reset
                        </a>
                        <a href="#" onclick="window.print()" class="btn btn-info">
                            <i class="bi bi-printer"></i> Print
                        </a>
                        <a href="#" class="btn btn-success">
                            <i class="bi bi-file-earmark-excel"></i> Export Excel
                        </a>
                    </div>
                </form>
                </div>
            </div>
        </div>
    </div>


    <div class="row mt-3">
        <div class="col-md-12">
            <div class="card rounded-3 border-0 shadow-sm">
                <div class="card-body table-responsive">
                    <h5>Daftar Bank Keluar</h5>
                    @if(request('bank_tujuan'))
                        <p class="text-muted">
                            Menampilkan data untuk: 
                            
                                {{ $bankTujuanList->where('id_bank_tujuan', request('bank_tujuan'))->first()->nama_tujuan ?? '' }}
                            
                        </p>
                        <table class="table table-bordered table-striped">
                        <thead class="text-center table-primary">
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Bukti</th>
                                <th>Bank Tujuan</th>
                                <th>Penerima</th>
                                <th>Uraian</th>
                                <th>Debet</th>
                                <th>Kredit</th>
                                <th>Saldo Akhir</th>
                                <th>No Input SAP</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse($data as $index => $row)
                                <tr>
                                    <td class="text-center">{{ $index + 1 }}</td>
                                    <td>{{ \Carbon\Carbon::parse($row->tanggal_keluar)->format('d/m/Y') }}</td>
                                    <td class="text-center">{{ $index + 1 }}</td>
                                    <td>{{ $row->bankTujuan->nama_tujuan ?? '-' }}</td>
                                    <td>{{ $row->penerima }}</td>
                                    <td>{{ $row->uraian }}</td>
                                    <td class="text-end">@currency($row->debet)</td>
                                    <td class="text-end">@currency($row->kredit)</td>
                                    <td class="text-end">
                                        @currency($row->saldo_akhir)
                                    </td>
                                    <td class="text-center">{{ $row->no_sap ?? '-' }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="10" class="text-center">Data tidak ditemukan</td>
                                </tr>
                            @endforelse
                        </tbody>
                        @if($data->count() > 0)
                            <tfoot class="">
                                <tr>
                                    <th colspan="7" class="text-end">TOTAL:</th>
                                    <!-- <th class="text-end">@currency($data->sum('debet'))</th>
                                    <th class="text-end">@currency($data->sum('kredit'))</th> -->
                                    <th class="text-end">
                                        @currency($data->last()->saldo_akhir)
                                    </th>
                                  
                                </tr>
                            </tfoot>
                        @endif
                    </table>
                    @endif

                    @if(request('sumber_dana'))
                        <p class="text-muted">
                            Menampilkan data untuk sumber dana:
                            
                                {{ $sumberDanaList->where('id_sumber_dana', request('sumber_dana'))->first()->nama_dana ?? '' }}
                            
                        </p>
                        <table class="table table-bordered table-striped">
                        <thead class="text-center table-primary">
                            <tr>
                                <th>No</th>
                                <th>Tanggal</th>
                                <th>Bukti</th>
                                <th>Sumber Dana</th>
                                <th>Bank Tujuan</th>
                                <th>Penerima</th>
                                <th>Uraian</th>
                                <th>Debet</th>
                                <th>Kredit</th>
                                <th>Saldo Akhir</th>
                                <th>No Input SAP</th>
                            </tr>
                        </thead>
                        <tbody>
                            @forelse($data as $index => $row)
                                <tr>
                                    <td class="text-center">{{ $index + 1 }}</td>
                                    <td>{{ \Carbon\Carbon::parse($row->tanggal_keluar)->format('d/m/Y') }}</td>
                                    <td class="text-center">{{ $index + 1 }}</td>
                                    <td>{{ $row->sumber_dana->nama_sumber_dana ?? '-' }}</td>
                                    <td>{{ $row->bankTujuan->nama_tujuan ?? '-' }}</td>
                                    <td>{{ $row->penerima }}</td>
                                    <td>{{ $row->uraian }}</td>
                                    <td class="text-end"><a href="#">@currency($row->debet)</a></td>
                                    <td class="text-end">@currency($row->kredit)</td>
                                    <td class="text-end">
                                        @currency($row->saldo_akhir)
                                    </td>
                                    <td class="text-center">{{ $row->no_sap ?? '-' }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="10" class="text-center">Data tidak ditemukan</td>
                                </tr>
                            @endforelse
                        </tbody>
                        @if($data->count() > 0)
                            <tfoot class="table-secondary">
                                <tr>
                                    <th colspan="9" class="text-end table-danger">TOTAL Saldo_akhir Terakhir :</th>
                                    <!-- <th class="text-end">@currency($data->sum('debet'))</th>
                                    <th class="text-end">@currency($data->sum('kredit'))</th> -->
                                    <th class="text-end table-danger">
                                        @currency($data->last()->saldo_akhir)
                                    </th>
                    
                                </tr>
                            </tfoot>
                        @endif
                    </table>
                    @endif

                    {{-- TAMPILKAN REKAP SALDO VA / BANK --}}
                    @if(request('rekapanVA') && in_array(request('rekapanVA'), ['va', 'bank']))
                        <h5 class="mt-4">
                            Rekapan Saldo 
                            @if(request('rekapanVA') == 'va') Virtual Account (VA) @endif
                            @if(request('rekapanVA') == 'bank') Bank @endif
                        </h5>

                        <table class="table table-bordered table-striped mt-2">
                            <thead class=" text-center table-primary">
                                <tr>
                                    <th>No</th>
                                    <th>Bank / Akun VA</th>
                                    <th>Saldo VA</th>
                                    <th>Saldo SAP</th>
                                    <th>Selisih</th>
                                    <th>Keterangan</th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach($rekapVA as $i => $row)
                                    <tr>
                                        <td class="text-center">{{ $i + 1 }}</td>
                                        <td>{{ $row['bank'] ?? '-' }}</td>
                                        <td class="text-end">@currency($row['saldo_va'] ?? 0)</td>
                                        <td class="text-end">@currency($row['saldo_sap'] ?? 0)</td>
                                        <td class="text-end">@currency($row['selisih'] ?? 0)</td>
                                        <td>{{ $row['keterangan'] ?? '-' }}</td>
                                    </tr>
                                @endforeach
                            </tbody>
                        </table>
                    @endif

                    @if(request('rekapanVA') === 'kategori-full')

                        <h5 class="mt-4">Rekapan Kategori Full</h5>

                        <table class="table table-bordered table-striped mt-2">
                            <thead class="table-primary text-center">
                                <tr>
                                    <th>Kategori</th>
                                    <th>Sub Kriteria</th>
                                    <th>Item</th>
                                    <th>Kredit</th>
                                </tr>
                            </thead>

                            <tbody>

                            @foreach($rekapVA as $kategori => $subs)

                                @php
                                    // Hitung berapa total baris kategori (jumlah item + total sub + total kategori)
                                    $rowspanKategori = 0;
                                    $totalKategori = 0; 
                                    
                                    foreach ($subs as $sub => $items) {
                                        $rowspanKategori += count($items) + 1; 
                                        
                                        // Hitung total kategori
                                        foreach ($items as $item) {
                                            if (isset($item['kredit']) && is_numeric($item['kredit'])) {
                                                $totalKategori += floatval($item['kredit']);
                                            }
                                        }
                                    }
                                    
                                    $rowspanKategori += 1; 

                                    $firstKategoriPrinted = false;
                                @endphp


                                @foreach($subs as $sub => $items)

                                    @php
                                        $rowspanSub = count($items) + 1; 
                                        
                                   
                                        $totalSub = 0;
                                        if (is_array($items)) {
                                            foreach ($items as $item) {
                                                if (isset($item['kredit']) && is_numeric($item['kredit'])) {
                                                    $totalSub += floatval($item['kredit']);
                                                }
                                            }
                                        }
                                        
                                        $firstSubPrinted = false;
                                    @endphp

                                    @foreach($items as $item)
                                        <tr>
                                            {{-- Kategori tampil sekali --}}
                                            @if(!$firstKategoriPrinted)
                                                <td rowspan="{{ $rowspanKategori }}" class="">
                                                    {{ $kategori }}
                                                </td>
                                                @php $firstKategoriPrinted = true; @endphp
                                            @endif

                                            {{-- Sub tampil sekali --}}
                                            @if(!$firstSubPrinted)
                                                <td rowspan="{{ $rowspanSub }}" >
                                                    {{ $sub }}
                                                </td>
                                                @php $firstSubPrinted = true; @endphp
                                            @endif

                                            {{-- Item --}}
                                            <td>{{ $item['item'] ?? '-' }}</td>

                                            {{-- Kredit dengan Link --}}
                                            <td class="text-end">
                                                <a href="{{ route('detailItem.index', [
                                                    'kategori' => $kategori,
                                                    'sub' => $sub,
                                                    'item' => $item['item'] ?? '-',
                                                    'tahun' => request('tahun')
                                                ]) }}" 
                                                class="text-decoration-none text-dark ">
                                                    @currency($item['kredit'] ?? 0)
                                                </a>
                                            </td>
                                        </tr>
                                    @endforeach

                                   


                                    {{-- Total Sub --}}
                                    <tr >
                                        {{-- Item --}}
                                        <!-- <td>{{ $sub ?? '-' }}</td> -->
                                        <td class="text-end " colspan="1">TOTAL {{ $sub }}</td>
                                        <td class="text-end "><a href="{{ route('detailSub.index', [
                                                    'kategori' => $kategori,
                                                    'sub' => $sub,
                                                    'item' => 'ALL', 
                                                    'tahun' => request('tahun')
                                                ]) }}" 
                                                class="text-decoration-none text-success ">
                                                    @currency($totalSub)
                                                </a></td>
                                    </tr>
                                    
                                @endforeach

                                {{-- TOTAL KATEGORI (ditambahkan di sini) --}}
                                <tr class="table-danger">
                                    <td class="text-end " colspan="2">
                                        TOTAL {{ strtoupper($kategori) }}
                                    </td>
                                    <td class="text-end ">
                                        @currency($totalKategori)</a>
                                    </td>
                                </tr>
                                
                            @endforeach

                            </tbody>
                        </table>

                    @endif

                    @if(request('rekapanVA') === 'kategori')

                        <h5 class="mt-4">Rekapan Kategori</h5>

                        <table class="table table-bordered table-striped mt-2">
                            <thead class="table-primary text-center">
                                <tr>
                                    <th>No</th>
                                    <th>Nama Kategori</th>
                                    <th>Total Saldo (Kredit)</th>
                                </tr>
                            </thead>

                            <tbody>
                                @foreach($rekapVA as $i => $row)
                                    <tr>
                                        <td class="text-center">{{ $i + 1 }}</td>
                                        <td class="">{{ $row->kategori }}</td>
                                        <td class="text-end ">
                                            @currency($row->total_kredit)
                                        </td>
                                    </tr>
                                @endforeach
                            </tbody>
                        </table>
                    @endif

                    <hr>
                </div>
            </div>
        </div>
    </div>
</div>


@push('scripts')
<!-- @push('scripts') -->
<script>
    // Initialize VirtualSelect
    VirtualSelect.init({ 
        ele: '#multipleSelect',
        placeholder: 'Pilih Sumber Dana',
        search: true,
        searchPlaceholderText: 'Cari sumber dana...',
        multiple: true,
        selectAllText: 'Pilih Semua',
        clearButtonText: 'Hapus',
        noSearchResultsText: 'Tidak ditemukan',
        noOptionsText: 'Tidak ada data',
        optionsSelectedText: 'dipilih',
        optionSelectedText: 'dipilih',
        allOptionsSelectedText: 'Semua dipilih',
        maxWidth: '100%',
        zIndex: 10
    });

    // Auto submit ketika VirtualSelect berubah
    document.querySelector('#multipleSelect').addEventListener('change', function() {
        document.getElementById('filterForm').submit();
    });
</script>
<!-- @endpush -->
@endpush
@endsection
<script>
document.addEventListener("DOMContentLoaded", function() {
    VirtualSelect.init({
        ele: '#multipleSelect'
    });
});
</script>
                            <!-- <select id="multipleSelect" multiple name="sumber_dana[]" placeholder="Pilih Sumber Dana" data-search="true">
                                @foreach($sumberDanaList as $sd)
                                    <option value="{{ $sd->id_sumber_dana }}" {{ request('sumber_dana') == $sd->id_sumber_dana ? 'selected' : '' }}>
                                        {{ $sd->nama_sumber_dana }}
                                    </option>
                                @endforeach
                            </select> -->
@endsection



<script>
document.addEventListener("DOMContentLoaded", function() {
    VirtualSelect.init({
        ele: '#multipleSelect'
        // dropdownParent: b
        
    });
});
</script>

<!-- enar -->
// $(function () {
//     $('.selectpicker').selectpicker();

//     $('.selectpicker').on('changed.bs.select', function () {
//         this.form.submit();
//     });
// });

  <!-- Sumber Dana -->
                            <!-- <div class="col-md-3">
                                <label class="form-label">Sumber Dana</label>
                                <select name="sumber_dana" class="form-select" onchange="this.form.submit()">
                                    <option value="">Semua Sumber Dana</option>
                                    @foreach($sumberDanaList as $sd)
                                        <option value="{{ $sd->id_sumber_dana }}" {{ request('sumber_dana') == $sd->id_sumber_dana ? 'selected' : '' }}>
                                            {{ $sd->nama_sumber_dana }}
                                        </option>
                                    @endforeach
                                </select>
                            </div> -->
                            <!-- Sumber Dana Multi-Select dengan Checkbox -->
                            <!-- <div class="col-md-3">
                                <select name="sumber_dana[]" class="form-select"  multiple onchange="this.form.submit()">
                                    @foreach($sumberDanaList as $sd)
                                        <option value="{{ $sd->id_sumber_dana }}"
                                            {{ in_array($sd->id_sumber_dana, request('sumber_dana', [])) ? 'selected' : '' }}>
                                            {{ $sd->nama_sumber_dana }}
                                        </option>
                                    @endforeach
                                </select>
                                <small class="text-muted">Ctrl / Shift untuk pilih banyak</small>
                            </div> -->
                            <!-- <div class="col-md-3">
                                <select class="selectpicker form-control"
                                        name="sumber_dana[]"
                                        multiple
                                        data-actions-box="true"
                                        data-selected-text-format="count"
                                        data-live-search="true"
                                        title="Semua Sumber Dana"
                                        onchange="this.form.submit()">

                                    @foreach($sumberDanaList as $sd)
                                        <option value="{{ $sd->id_sumber_dana }}"
                                            {{ in_array($sd->id_sumber_dana, request('sumber_dana', [])) ? 'selected' : '' }}>
                                            {{ $sd->nama_sumber_dana }}
                                        </option>
                                    @endforeach

                             </select>
                        </div> -->