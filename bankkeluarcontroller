<?php

namespace App\Http\Controllers;

use App\Models\Dokumen;
use App\Models\BankKeluar;
use App\Models\BankTujuan;
use App\Models\SumberDana;
use App\Models\SubKriteria;
use Illuminate\Http\Request;
use App\Models\ItemSubKriteria;
use App\Models\KategoriKriteria;
use Illuminate\Support\Facades\DB;

class BankKeluarController extends Controller
{
    public function index()
    {
        
        $agendaData = Dokumen::select(
        'id', 
        DB::raw("CONCAT(nomor_agenda,'_',tahun) as agenda_tahun"),
        'uraian_spp',
        'nilai_rupiah',
        'dibayar_kepada'
    )->get();
        return view('cash bank.bankKeluar', [
            'agenda' => $agendaData,
            'sumberDana'       => SumberDana::all(),
            'bankTujuan'       => BankTujuan::all(),
            'kategoriKriteria' => KategoriKriteria::all(),
            'subKriteria'      => SubKriteria::all(),
            'itemSubKriteria'  => ItemSubKriteria::all(),
        ]);
    }

    public function create()
    {
        return view('bank_keluars.create', [
            // 'agenda'            => Dokumen::select('id','agenda_tahun')->get(),
            'agenda' => Dokumen::select(
            'id', 
            DB::raw("CONCAT(nomor_agenda,'_',tahun) as agenda_tahun"),
            'uraian',           
            'nilai_rupiah',    
            'dibayar_kepada as penerima'          
        )->get(),
            'sumberDana'        => SumberDana::all(),
            'bankTujuan'        => BankTujuan::all(),
            'kategoriKriteria'  => KategoriKriteria::all(),
            'subKriteria' => SubKriteria::all(),
            'itemSubKriteria' => ItemSubKriteria::all(),
        ]);
    }
//     public function store(Request $request)
// {
//     try {

//         // Ambil nilai dari select agenda
//         $agendaValue = $request->dokumen_id; // ini dari select2
    

//         // Tentukan apakah input adalah dokumen lama atau input baru
//         $isOldAgenda = is_numeric($agendaValue);

//         // Jika agenda lama â†’ ambil dokumen
//         if ($isOldAgenda) {
//             $dok = Dokumen::findOrFail($agendaValue);

//             $dokumen_id = $dok->id;
//             $no_agenda  = $dok->nomor_agenda;
//             $agenda_tahun = $dok->nomor_agenda . '_' . $dok->tahun;

//             // Update data dokumen
//             $dok->update([
//                 'uraian_spp'     => $request->uraian,
//                 'nilai_rupiah'   => $request->nilai_rupiah,
//                 'dibayar_kepada' => $request->penerima,
//                 'tanggal_dibayar'=> $request->tanggal_keluar
//             ]);

//         } else {
//             // Jika input baru
//             $dokumen_id = null;
//             $no_agenda  = null;
//             $agenda_tahun = $agendaValue; // simpan apa adanya ke tabel bank_keluar
//         }

//         // Simpan bank keluar
//         $bank = BankKeluar::create([
//             'dokumen_id'         => $dokumen_id,
//             'no_agenda'          => $no_agenda,
//             'agenda_tahun'       => $agenda_tahun,
//             'id_sumber_dana'     => $request->id_sumber_dana,
//             'id_bank_tujuan'     => $request->id_bank_tujuan,
//             'id_kategori_kriteria' => $request->id_kategori_kriteria,
//             'id_sub_kriteria'    => $request->id_sub_kriteria,
//             'id_item_sub_kriteria' => $request->id_item_sub_kriteria,
//             'uraian'             => $request->uraian,
//             'nilai_rupiah'       => $request->nilai_rupiah,
//             'penerima'           => $request->penerima,
//             'tanggal_keluar'     => $request->tanggal_keluar,
//             'debet'              => $request->debet,
//             'kredit'             => $request->kredit,
//             'keterangan'         => $request->keterangan,
//         ]);

//         return back()->with('success', 'Data berhasil disimpan');

//     } catch (\Exception $e) {
//         return back()->with('error', $e->getMessage())->withInput();
//     }
// }
public function store(Request $request)
{
    try {

        $agendaValue = $request->dokumen_id;
        $isOldAgenda = is_numeric($agendaValue);

        if ($isOldAgenda) {

            $dok = Dokumen::findOrFail($agendaValue);

            $dokumen_id = $dok->id;
            $no_agenda  = $dok->nomor_agenda;
            $agenda_tahun = $dok->nomor_agenda . '_' . $dok->tahun;

            $dok->update([
                'uraian_spp'     => $request->uraian,
                'nilai_rupiah'   => $request->nilai_rupiah,
                'dibayar_kepada' => $request->penerima,
                'tanggal_dibayar'=> $request->tanggal_keluar
            ]);

        } else {

            $dokumen_id = null;

            if (strpos($agendaValue, '_') !== false) {
                [$no_agenda, $tahun] = explode('_', $agendaValue);
            } else {
                $no_agenda = null;
            }

            $agenda_tahun = $agendaValue;
        }

        BankKeluar::create([
            'dokumen_id'         => $dokumen_id,
            'no_agenda'          => $no_agenda,
            'agenda_tahun'       => $agenda_tahun,
            'id_sumber_dana'     => $request->id_sumber_dana,
            'id_bank_tujuan'     => $request->id_bank_tujuan,
            'id_kategori_kriteria' => $request->id_kategori_kriteria,
            'id_sub_kriteria'    => $request->id_sub_kriteria,
            'id_item_sub_kriteria' => $request->id_item_sub_kriteria,
            'uraian'             => $request->uraian,
            'nilai_rupiah'       => $request->nilai_rupiah,
            'penerima'           => $request->penerima,
            'tanggal_keluar'     => $request->tanggal_keluar,
            'debet'              => $request->debet,
            'kredit'             => $request->kredit,
            'keterangan'         => $request->keterangan,
        ]);

        return back()->with('success', 'Data berhasil disimpan');

    } catch (\Exception $e) {
        return back()->with('error', $e->getMessage())->withInput();
    }
}

//     public function store(Request $request)
// {
//     // Log semua data yang masuk
//     \Log::info('=== BANK KELUAR STORE REQUEST ===');
//     \Log::info('Request Data:', $request->all());

//     try {
//         // Validasi
//         $validated = $request->validate([
//             // 'dokumen_id'             => 'required|exists:dokumens,id',
//             'dokumen_id' => 'nullable|exists:dokumens,id',
//             'agenda_tahun' => 'required|string',
//             'id_sumber_dana'         => 'required|exists:sumber_dana,id_sumber_dana',
//             'id_bank_tujuan'         => 'nullable|exists:bank_tujuan,id_bank_tujuan',
//             'id_kategori_kriteria'   => 'required|exists:kategori_kriteria,id_kategori_kriteria',
//             'id_sub_kriteria'        => 'required|exists:sub_kriteria,id_sub_kriteria',
//             'id_item_sub_kriteria'   => 'required|exists:item_sub_kriteria,id_item_sub_kriteria',
//             'uraian'                 => 'required|string',
//             'nilai_rupiah'           => 'required|numeric|min:0',
//             'penerima'               => 'nullable|string',
//             'tanggal_keluar'         => 'required|date',
//             'debet'                  => 'nullable|numeric|min:0',
//             'kredit'                 => 'nullable|numeric|min:0',
//             'keterangan'             => 'nullable|string',
//         ], [
//             'dokumen_id.required' => 'Agenda harus dipilih',
//             'id_sumber_dana.required' => 'Sumber Dana harus dipilih',
//             'id_bank_tujuan.required' => 'Bank Tujuan harus dipilih',
//             'id_kategori_kriteria.required' => 'Kriteria CF harus dipilih',
//             'id_sub_kriteria.required' => 'Sub Kriteria harus dipilih',
//             'id_item_sub_kriteria.required' => 'Item Sub Kriteria harus dipilih',
//             'tanggal_keluar.required' => 'Tanggal Keluar harus diisi',
//         ]);

//         // \Log::info('âœ… Validation passed');

//         // Start database transaction
//         DB::beginTransaction();

//         try {
//             $agenda = $request->agenda_input;

//             if(is_numeric($request->agenda_input)) {
//                 // pilih dari dokumen â†’ update dokumen
//                 $dok = Dokumen::find($request->agenda_input);
//                 $dok->update([
//                     'uraian_spp'     => $request->uraian,
//                     'nilai_rupiah'   => $request->nilai_rupiah,
//                     'dibayar_kepada' => $request->penerima,
//                     'tanggal_dibayar'=> $request->tanggal_keluar
//                 ]);
//                 $dokumen_id = $dok->id;
//                 $no_agenda = $dok->nomor_agenda;
//             } else {
//                 // input baru â†’ tidak update dokumen
//                 $dokumen_id = null;
//                 $no_agenda = null;
//             }
            
//             // simpan bank keluar
//             BankKeluar::create([
//                 'dokumen_id' => $dokumen_id,
//                 'no_agenda'  => $no_agenda,
//                 'agenda_tahun'=> $request->agenda_tahun,
//                 'id_sumber_dana'=> $request->id_sumber_dana,
//                 'id_bank_tujuan'=> $request->id_bank_tujuan,
//                 'id_kategori_kriteria'=> $request->id_kategori_kriteria,
//                 'id_sub_kriteria'=> $request->id_sub_kriteria,
//                 'id_item_sub_kriteria'=> $request->id_item_sub_kriteria,
//                 'uraian' => $request->uraian,
//                 'nilai_rupiah'=> $request->nilai_rupiah,
//                 'penerima'=> $request->penerima,
//                 'tanggal_keluar'=> $request->tanggal_keluar,
//                 'debet'=> $request->debet,
//                 'kredit'=> $request->kredit,
//                 'keterangan'=> $request->keterangan,
//             ]);

//             \Log::info('ğŸ’¾ BankKeluar created:', [
//                 'id' => $bankKeluar->id,
//                 'agenda_tahun' => $bankKeluar->agenda_tahun
//             ]);

//             // Commit transaction
//             DB::commit();

//             \Log::info('âœ… Transaction committed successfully');

//             return redirect()->back()->with('success', 'Data berhasil disimpan! Agenda: ' . $agenda_tahun);

//         } catch (\Exception $e) {
//             // Rollback jika ada error
//             DB::rollBack();
            
//             \Log::error('âŒ Database transaction failed:', [
//                 'message' => $e->getMessage(),
//                 'file' => $e->getFile(),
//                 'line' => $e->getLine()
//             ]);

//             throw $e; // Re-throw untuk catch luar
//         }

//     } catch (\Illuminate\Validation\ValidationException $e) {
//         \Log::error('âŒ Validation failed:', ['errors' => $e->errors()]);
        
//         return redirect()->back()
//             ->withErrors($e->errors())
//             ->withInput()
//             ->with('error', 'Validasi gagal. Periksa kembali semua field yang bertanda *');
            
//     } catch (\Exception $e) {
//         \Log::error('âŒ Store error:', [
//             'message' => $e->getMessage(),
//             'file' => $e->getFile(),
//             'line' => $e->getLine(),
//             'trace' => $e->getTraceAsString()
//         ]);
        
//         return redirect()->back()
//             ->withInput()
//             ->with('error', 'Terjadi kesalahan: ' . $e->getMessage());
//     }
// }


    public function getSub($id)
    {
        return SubKriteria::where('id_kategori_kriteria', $id)->get();
    }

    public function getItem($id)
    {
        return ItemSubKriteria::where('id_sub_kriteria', $id)->get();
    }

    public function getDokumenDetail($id)
    {
        try {
            $dokumen = Dokumen::select(
                'id',
                'uraian_spp as uraian',         // samakan dengan JS
                'nilai_rupiah',
                'dibayar_kepada as penerima'   // samakan dengan JS
            )->findOrFail($id);

            return response()->json([
                'success' => true,
                'data' => $dokumen
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Data tidak ditemukan'
            ], 404);
        }
    }
    }
